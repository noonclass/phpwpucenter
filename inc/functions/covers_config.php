<?php/*!**************************************************************Theme Name: MOE-PIXTheme URI: http://moemob.com/moe-pixAuthor: 萌える動 • 萌动网Author URI: http://moemob.comDescription: 时尚自适应图片主题，集成了功能强大的前台用户中心Version: 1.0Package: Ucenter & Market****************************************************************/?><?php/* 创建数据表/* ------------ */function cover_table_create() {    global $wpdb;    $table_name = $wpdb->prefix . 'covers';    if( $wpdb->get_var("SHOW TABLES LIKE '$table_name'") != $table_name ) {		$sql = " CREATE TABLE `$table_name` (            `cover_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,            `cover_name` varchar(100) NOT NULL,            `cover_biography` varchar(255)  NOT NULL,            PRIMARY KEY (cover_id),            UNIQUE KEY cover_index (cover_name)		) COLLATE {$wpdb->collate};";		require_once(ABSPATH . 'wp-admin/includes/upgrade.php');		dbDelta($sql);    }        $table_name = $wpdb->prefix . 'post_cover';    if( $wpdb->get_var("SHOW TABLES LIKE '$table_name'") != $table_name ) {		$sql = " CREATE TABLE `$table_name` (            `ID` bigint(20) unsigned NOT NULL AUTO_INCREMENT,            `post_id` bigint(20) unsigned NOT NULL default '0',   			`cover_id` bigint(20) unsigned NOT NULL default '0',            PRIMARY KEY (ID),			UNIQUE KEY post_index (post_id, cover_id)		) COLLATE {$wpdb->collate};";		require_once(ABSPATH . 'wp-admin/includes/upgrade.php');		dbDelta($sql);    }}add_action( 'admin_menu', 'cover_table_create' );/* 添加自定义面板/* ------------ */function cover_meta_box_html(){    $name = '';    $bio = '';    global $wpdb, $post;    $table_name = $wpdb->prefix . 'post_cover';    $sql = "SELECT cover_id FROM $table_name WHERE post_id='$post->ID'";    $results = $wpdb->get_results( $sql );    $cover_id = 0;    if($results){        $cover_id = $results[0]->cover_id;    }        $table_name = $wpdb->prefix . 'covers';    $sql = "SELECT cover_name, cover_biography FROM $table_name WHERE cover_id='$cover_id'";    $results = $wpdb->get_results( $sql );    if($results){        $name = $results[0]->cover_name;        $bio = $results[0]->cover_biography;    }        // We'll use this nonce field later on when saving.    wp_nonce_field( 'cover_meta_box_nonce', 'meta_box_nonce' );    ?>    <div class="misc-pub-section misc-pub-post-cover">        姓名: <input type="text" name="cover_name" id="cover_name" value="<?php echo $name; ?>" />    </div>    <div class="misc-pub-section misc-pub-post-cover">        简介: <textarea name="cover_biography" id="cover_biography"><?php echo $bio; ?></textarea>    </div>    <?php}function cover_meta_box_add(){    add_meta_box( 'cover-meta-box-id', '封面人物', 'cover_meta_box_html', 'post', 'side', 'high', array() );}add_action( 'add_meta_boxes', 'cover_meta_box_add' );/* 保持数据到DB/* ------------ */function cover_meta_box_save( $post_id ){    // Bail if we're doing an auto save    if( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) return;         // if our nonce isn't there, or we can't verify it, bail    if( !isset( $_POST['meta_box_nonce'] ) || !wp_verify_nonce( $_POST['meta_box_nonce'], 'cover_meta_box_nonce' ) ) return;         // if our current user can't edit this post, bail    if( !current_user_can( 'edit_post' ) ) return;         $cover_id = isset( $_POST['cover_id'] ) ? $_POST['cover_id'] : '';    $cover_name = isset( $_POST['cover_name'] ) ? $_POST['cover_name'] : '';    $cover_biography = isset( $_POST['cover_biography'] ) ? $_POST['cover_biography'] : '';    if( !empty( $cover_name ) ) {reselect:        global $wpdb;        $table_name = $wpdb->prefix . 'covers';        $sql = "SELECT cover_id FROM $table_name WHERE cover_name='$cover_name'";        $results = $wpdb->get_results( $sql );        if(!$results){            $sql = "INSERT INTO $table_name (cover_name, cover_biography) VALUES ('$cover_name', '$cover_biography')";            $wpdb->query( $sql );            goto reselect;        }                // update value        $cover_id = $results[0]->cover_id;                $table_name = $wpdb->prefix . 'post_cover';        $sql = "SELECT cover_id FROM $table_name WHERE post_id='$post_id' and cover_id='$cover_id'";        $results = $wpdb->get_results( $sql );        if(!$results){            $sql = "INSERT INTO $table_name (post_id,cover_id) VALUES ('$post_id', '$cover_id')";            $wpdb->query( $sql );        }    }}add_action( 'save_post', 'cover_meta_box_save' );/* 获取文章的封面信息/* ------------------ */function cover_get_profile( $post_id ){    global $wpdb;    $table_name = $wpdb->prefix . 'post_cover';    $sql = "SELECT cover_id FROM $table_name WHERE post_id='$post_id'";    $results = $wpdb->get_results( $sql );    $cover_id = 0;    if($results){        $cover_id = $results[0]->cover_id;    }        $table_name = $wpdb->prefix . 'covers';    $sql = "SELECT cover_name, cover_biography FROM $table_name WHERE cover_id='$cover_id'";    $results = $wpdb->get_results( $sql );    if($results){        return $results;    }    return array();}/* 获取文章的封面信息/* ------------------ */function cover_get_post_ids( $post_id ){    global $wpdb;    $table_name = $wpdb->prefix . 'post_cover';    $sql = "SELECT cover_id FROM $table_name WHERE post_id='$post_id'";    $results = $wpdb->get_results( $sql );    $cover_id = 0;    if($results){        $cover_id = $results[0]->cover_id;    }        global $wpdb;    $table_name = $wpdb->prefix . 'post_cover';    $sql = "SELECT post_id FROM $table_name WHERE cover_id='$cover_id' and post_id!='$post_id'";    $ids = $wpdb->get_col( $sql );    if(count($ids)>0){        return $ids;    }    return array();}?>